/*
Đề: 2
*/
-- Câu 1: Viết các câu lệnh SQL tạo quan hệ trên (kèm khóa chính) với các kiểu
-- dữ liệu mô tả trong bảng mô tả.
CREATE TABLE XETAI(
	MAXE CHAR(10),
	MALX CHAR(4),
	NGMUA SMALLDATETIME,
	SOKM INT,
	PRIMARY KEY (MAXE)
)

CREATE TABLE LOAIXE(
	MALX CHAR(4),
	TENLX NVARCHAR(20),
	NHASX NVARCHAR(20),
	TAITRONG INT,
	NIENHAN INT,
	PRIMARY KEY (MALX)
)

CREATE TABLE TAIXE(
	MATX CHAR(4),
	HOTEN NVARCHAR(50),
	GTINH NVARCHAR(3),
	NGAYVL SMALLDATETIME,
	PRIMARY KEY (MATX)
)

CREATE TABLE BANGLAI(
	MABL CHAR(4),
	MATX CHAR(4),
	NGCAP SMALLDATETIME,
	LOAI CHAR(2),
	PRIMARY KEY (MABL)
)

CREATE TABLE VANCHUYEN(
	MAVC CHAR(4),
	MATX CHAR(4),
	MAXE CHAR(10),
	KLUONG INT,
	QDUONG INT,
	NGVC SMALLDATETIME,
	PRIMARY KEY (MAVC)
)

-- Câu 2: Tạo ràng buộc khóa ngoại (4 hoặc 5 khóa)
ALTER TABLE BANGLAI
ADD CONSTRAINT FK_BANGLAI_MATX FOREIGN KEY(MATX) REFERENCES TAIXE(MATX)

ALTER TABLE VANCHUYEN
ADD CONSTRAINT FK_VC_MATX FOREIGN KEY(MATX) REFERENCES TAIXE(MATX)

ALTER TABLE VANCHUYEN
ADD CONSTRAINT FK_VC_MAXE FOREIGN KEY(MAXE) REFERENCES XETAI(MAXE)

ALTER TABLE XETAI
ADD CONSTRAINT FK_XETAI_MALX FOREIGN KEY(MALX) REFERENCES LOAIXE(MALX)
-- Câu 3: Đối với mỗi quan hệ, xác định thêm 1 ràng buộc
ALTER TABLE XETAI
ADD CONSTRAINT CHK_SOKM CHECK(SOKM >= 0)

ALTER TABLE LOAIXE
ADD CONSTRAINT CHK_TAITRONG CHECK(TAITRONG >= 0)

ALTER TABLE TAIXE
ADD CONSTRAINT CHK_GTINH CHECK(GTINH IN (N'Nam', N'Nữ'))	

ALTER TABLE BANGLAI
ADD CONSTRAINT CHK_MABL_MATX CHECK(SUBSTRING(MABL, 2, 3) = SUBSTRING(MATX, 2, 3))

ALTER TABLE VANCHUYEN
ADD CONSTRAINT CHK_QDUONG CHECK(QDUONG >= 0)	

-- Câu 4: Cập nhật dữ liệu
SET DATEFORMAT DMY

-- Cập nhật bảng XETAI (1)
INSERT INTO XETAI (MAXE, NGMUA, SOKM) VALUES('M001', '20/1/2017', 1500)
INSERT INTO XETAI (MAXE, NGMUA, SOKM) VALUES('M003', '22/7/2019', 1743)
INSERT INTO XETAI (MAXE, NGMUA, SOKM) VALUES('M005', '26/3/2018', 9745)
INSERT INTO XETAI (MAXE, NGMUA, SOKM) VALUES('M007', '21/8/2017', 4577)
INSERT INTO XETAI (MAXE, NGMUA, SOKM) VALUES('M009', '25/9/2016', 9632)

-- Cập nhật bảng LOAIXE (2)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X002', N'Trường Phát', N'Việt Nam', 8, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X004', N'Hoàng Long', N'Thái Lan', 15, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X006', N'Phong Thuận', N'Hàn Quốc', 10, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X008', N'Nhơn Hỏa', N'Nhật Bản', 20, 5)
INSERT INTO LOAIXE (MALX, TENLX, NHASX, TAITRONG, NIENHAN) VALUES ('X010', N'Phượng Hoàng', N'LB Đức', 9, 5)

-- UPDATE lại bảng XETAI(1)
UPDATE XETAI SET MALX = 'X010' WHERE MAXE = 'M001'
UPDATE XETAI SET MALX = 'X008' WHERE MAXE = 'M003'
UPDATE XETAI SET MALX = 'X006' WHERE MAXE = 'M005'
UPDATE XETAI SET MALX = 'X004' WHERE MAXE = 'M007'
UPDATE XETAI SET MALX = 'X002' WHERE MAXE = 'M009'

-- Cập nhật bảng TAIXE(3)
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T001', N'Phạm Văn Hai', N'Nam', '15/10/2019')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T002', N'Nguyễn Văn Thanh', N'Nam', '18/12/2020')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T003', N'Lê Hồng Phát', N'Nữ', '25/7/2018')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T004', N'Nguyễn Ngọc Tâm', N'Nam', '5/3/2017')
INSERT INTO TAIXE(MATX, HOTEN, GTINH, NGAYVL) VALUES('T005', N'Trần Văn Tân', N'Nữ', '1/6/2021')

-- Cập nhật bảng BANGLAI(4)
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B001', 'T001', '10/11/2015', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B002', 'T002', '24/12/2014', 'C1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B003', 'T003', '17/10/2016', 'D1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B004', 'T004', '26/11/2018', 'E1')
INSERT INTO BANGLAI (MABL, MATX, NGCAP, LOAI) VALUES ('B005', 'T005', '29/12/2017', 'D3')

-- Cập nhật bảng VANCHUYEN(5)
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V001', 'T001', 'M001', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V002', 'T004', 'M003', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V003', 'T001', 'M005', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V004', 'T003', 'M007', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V005', 'T005', 'M009', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V006', 'T001', 'M001', 9, 100, '7/12/2019')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V007', 'T005', 'M005', 9, 100, '7/12/2020')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V008', 'T003', 'M009', 9, 100, '7/12/2021')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V009', 'T002', 'M003', 9, 100, '7/12/2022')
INSERT INTO VANCHUYEN (MAVC, MATX, MAXE, KLUONG, QDUONG, NGVC) VALUES('V010', 'T001', 'M007', 9, 100, '7/12/2021')

-- Câu 5: Liệt kê thông tin (MAXE, TENLX, NHASX, NIENHAN) của những chiếc xe mà công ty 
-- mua trong năm 2017. (chú ý không dùng "=")
-- Bảng: LOAIXE, XETAI
SELECT DISTINCT MAXE, TENLX, NHASX, NIENHAN
FROM LOAIXE, XETAI 
WHERE LOAIXE.MALX = XETAI.MALX
AND YEAR(NGMUA) IN (2017)

-- Câu 6: Liệt kê những tài xế (MATX, TENTX) có bằng lái xe loại "D1" được cấp
-- trong năm 2015, 2016 (chú ý không dùng "in")
-- Bảng: TAIXE, BANGLAI
-- Dùng phép hội 2 tập 2015 và 2016
SELECT DISTINCT TAIXE.MATX, HOTEN AS TENTX
FROM TAIXE, BANGLAI
WHERE TAIXE.MATX = BANGLAI.MATX AND LOAI = 'D1' AND YEAR(NGCAP) = 2015
UNION
SELECT DISTINCT TAIXE.MATX, HOTEN AS TENTX
FROM TAIXE, BANGLAI
WHERE TAIXE.MATX = BANGLAI.MATX AND LOAI = 'D1' AND YEAR(NGCAP) = 2016

-- Câu 7: Tìm xe (MAXE) có tổng quãng đường vận chuyển lớn nhất 
-- Bảng: VANCHUYEN, XETAI
SELECT TOP 1 WITH TIES XETAI.MAXE
FROM VANCHUYEN, XETAI
WHERE XETAI.MAXE = VANCHUYEN.MAXE
GROUP BY XETAI.MAXE
ORDER BY SUM(QDUONG) DESC

-- Câu 8: Tìm tài xế (MATX, TENTX) lái được tất cả các xe
-- Bảng: TAIXE, BANGLAI
SELECT DISTINCT MATX, HOTEN AS TENTX
FROM TAIXE
WHERE EXISTS (SELECT MATX FROM BANGLAI WHERE MATX = TAIXE.MATX)

-- Câu 9: Ràng buộc ngày vận chuyển hàng phải sau ngày mua xe
CREATE TRIGGER CHK_NGVC_NGMUAXE ON VANCHUYEN
FOR INSERT
AS 
BEGIN
	DECLARE @MAXE CHAR(10), @NGVC SMALLDATETIME, @MAXE2 CHAR(10)
	SELECT @MAXE = MAXE, @NGVC = NGVC FROM INSERTED

	SELECT @MAXE2 = MAXE FROM XETAI 
	WHERE MAXE = @MAXE AND @NGVC > NGMUA

	IF @MAXE = @MAXE2
		BEGIN
			PRINT N'Ngày vận chuyển hàng sau ngày mua xe! hợp lệ!'
		END
	ELSE
		BEGIN
			PRINT N'Ngày vận chuyển hàng không sau ngày mua xe! Lỗi!'
			ROLLBACK TRANSACTION
		END
END

-- Câu 10: Ràng buộc thời gian khối lượng vận chuyển(KLUONG) không quá
-- tải trọng (TAITRONG) 50% của xe.
CREATE TRIGGER CHK_KLUONG_TAITRONG ON VANCHUYEN
FOR INSERT
AS 
BEGIN
	DECLARE @MAXE CHAR(10), @KLUONG SMALLDATETIME, @MAXE2 CHAR(10)
	SELECT @MAXE = MAXE, @KLUONG = KLUONG FROM INSERTED

	SELECT @MAXE2 = MAXE FROM XETAI, LOAIXE
	WHERE MAXE = @MAXE AND LOAIXE.MALX = XETAI.MALX 
		AND @KLUONG < TAITRONG/2

	IF @MAXE = @MAXE2
		BEGIN
			PRINT N'Hợp lệ! khối lượng vận chuyển < 50% tải trọng xe!'
		END
	ELSE
		BEGIN
			PRINT N'Lỗi! khối lượng vận chuyển không < 50% tải trọng xe!'
			ROLLBACK TRANSACTION
		END
END
